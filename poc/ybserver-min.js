const{connection:connection,mysql:mysql}=require("../mods/dbconnection.js"),express=require("express"),bodyParser=require("body-parser"),session=require("client-sessions"),device=require("express-device"),app=express(),words=require("./words-min.js");let nav=[{name:"Introduction",link:""},{name:"Sign up",link:"n-signup"},{name:"Dashboard",link:"n-dashboard"},{name:"How to use",link:"n-howtouse"},{name:"Stage 1",link:"n-stage1"},{name:"Stage 2",link:"n-stage2"},{name:"Stage 3",link:"n-stage3"}];connection.connect(function(e){e?console.log(e):console.log("database connected")}),app.use(session({cookieName:"session",secret:"respqgepor30343DDmkivwkjndd-[]{}P022$",duration:432e5})),app.use("/",express.static(__dirname+"/../public")),setInterval(function(){connection.query("SELECT 1")},5e3),app.use(bodyParser.urlencoded({extended:!1})),app.use(bodyParser.json()),app.use(device.capture({parseUserAgent:!0})),device.enableDeviceHelpers(app),device.enableViewRouting(app),app.set("view engine","ejs"),app.use("/",function(e,n,s){if(n.header("Node-server",0),"/n-signup"===e.url||"POST"!==e.method||e.session.user)return e.session.user||"GET"!==e.method?s():void n.render(__dirname+"/../views/pages/index",{data:nav});n.status(200).send(!1)}),app.get("/",function(e,n,s){n.render(__dirname+"/../views/pages/introduction",{data:nav})}),app.get("/:name",function(e,n,s){let a=e.session.user?e.session.user:"not",i="SELECT * FROM auth WHERE id_user="+mysql.escape(a);connection.query(i,function(s,a,i){if(s)throw s;"n-signup"==e.params.name&&n.render(__dirname+"/../views/pages/index",{data:nav}),a.length>0&&("n-howtouse"==e.params.name?n.render(__dirname+"/../views/pages/how_to_use",{data:nav}):"n-stage1"==e.params.name?n.render(__dirname+"/../views/pages/stage_1",{data:nav}):"n-stage2"==e.params.name?n.render(__dirname+"/../views/pages/stage_2",{data:nav}):e.params.name)})}),app.get("/s*/data",function(e,n,s){n.send({data:words})}),app.post("/n-signup",function(e,n,s){if(nav.push({name:"",link:""}),e.body.email){let s="SELECT * FROM auth WHERE email_user = ?";connection.query(s,mysql.escape(e.body.email),function(s,a,i){if(s)nav[nav.length-1].msg=s,n.render(__dirname+"/../views/pages/index",{data:nav});else if(a.length>0)e.session.user?(nav[nav.length-1].msg="You are already logged in",n.render(__dirname+"/../views/pages/index",{data:nav})):(e.session.user=mysql.escape(a[0].id_user),nav[nav.length-1].msg="New session created",n.render(__dirname+"/../views/pages/index",{data:nav}));else{let s={email_user:mysql.escape(e.body.email)},a="INSERT INTO auth SET ?";connection.query(a,s,function(s,a){if(s)throw s;e.session.user=a.insertId,nav[nav.length-1].msg='Email sent. Please proceed to "How to use"',n.render(__dirname+"/../views/pages/index",{data:nav})})}})}else nav[nav.length-1].msg="Please add your email",n.render(__dirname+"/../views/pages/index",{data:nav})}),app.post("/symbol",function(e,n,s){console.log(e.body),n.set({"Content-Type":"text/plain"}),n.status(200).send(!0)});const port=process.env.PORT||4262;app.listen(port,function(){console.log(`Node app is running ${port}`)});